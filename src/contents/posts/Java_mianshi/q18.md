---
title: AOP (é¢å‘åˆ‡é¢ç¼–ç¨‹) çš„æ ¸å¿ƒæ¦‚å¿µæ˜¯ä»€ä¹ˆï¼ˆåˆ‡é¢ Aspectã€è¿æ¥ç‚¹ Join Pointã€é€šçŸ¥ Adviceã€åˆ‡ç‚¹ Pointcutï¼‰ï¼ŸSpring AOP æ˜¯å¦‚ä½•å®ç°çš„ï¼ˆåŠ¨æ€ä»£ç†ï¼šJDK Proxy å’Œ CGLIBï¼‰ï¼Ÿä½ æ›¾åœ¨é¡¹ç›®ä¸­ç”¨ AOP è§£å†³è¿‡ä»€ä¹ˆé—®é¢˜ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡ã€æƒé™æ§åˆ¶ï¼‰ï¼Ÿ
published: 2025-05-01
description: AOP (é¢å‘åˆ‡é¢ç¼–ç¨‹) çš„æ ¸å¿ƒæ¦‚å¿µæ˜¯ä»€ä¹ˆï¼ˆåˆ‡é¢ Aspectã€è¿æ¥ç‚¹ Join Pointã€é€šçŸ¥ Adviceã€åˆ‡ç‚¹ Pointcutï¼‰ï¼ŸSpring AOP æ˜¯å¦‚ä½•å®ç°çš„ï¼ˆåŠ¨æ€ä»£ç†ï¼šJDK Proxy å’Œ CGLIBï¼‰ï¼Ÿä½ æ›¾åœ¨é¡¹ç›®ä¸­ç”¨ AOP è§£å†³è¿‡ä»€ä¹ˆé—®é¢˜ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡ã€æƒé™æ§åˆ¶ï¼‰ï¼Ÿ
tags: [Markdown, Blogging]
category: Java mianshi
licenseName: "Unlicensed"
author: Ankou
sourceLink: ''
draft: false
---
AOP (é¢å‘åˆ‡é¢ç¼–ç¨‹) çš„æ ¸å¿ƒæ¦‚å¿µæ˜¯ä»€ä¹ˆï¼ˆåˆ‡é¢ Aspectã€è¿æ¥ç‚¹ Join Pointã€é€šçŸ¥ Adviceã€åˆ‡ç‚¹ Pointcutï¼‰ï¼ŸSpring AOP æ˜¯å¦‚ä½•å®ç°çš„ï¼ˆåŠ¨æ€ä»£ç†ï¼šJDK Proxy å’Œ CGLIBï¼‰ï¼Ÿä½ æ›¾åœ¨é¡¹ç›®ä¸­ç”¨ AOP è§£å†³è¿‡ä»€ä¹ˆé—®é¢˜ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡ã€æƒé™æ§åˆ¶ï¼‰ï¼Ÿ

**ä¸€ã€AOP æ ¸å¿ƒæ¦‚å¿µ**

AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰çš„æ ¸å¿ƒç›®æ ‡æ˜¯å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡ã€æƒé™ï¼‰ä»æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»ï¼Œé€šè¿‡æ¨¡å—åŒ–æ–¹å¼å¢å¼ºä»£ç å¤ç”¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚å…¶æ ¸å¿ƒæ¦‚å¿µå¦‚ä¸‹ï¼š

|        **æ¦‚å¿µ**         |                      **å®šä¹‰**                      |                           **ç¤ºä¾‹**                           |
| :---------------------: | :------------------------------------------------: | :----------------------------------------------------------: |
|    **åˆ‡é¢ (Aspect)**    |         å°è£…æ¨ªåˆ‡é€»è¾‘çš„æ¨¡å—ï¼ˆå¦‚æ—¥å¿—åˆ‡é¢ï¼‰ã€‚         |                     `@Aspect` æ³¨è§£çš„ç±»ã€‚                     |
| **è¿æ¥ç‚¹ (Join Point)** | ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„ç‰¹å®šæ—¶ç‚¹ï¼ˆå¦‚æ–¹æ³•è°ƒç”¨ã€å¼‚å¸¸æŠ›å‡ºï¼‰ã€‚ |             `UserService.addUser()` æ–¹æ³•æ‰§è¡Œæ—¶ã€‚             |
|    **é€šçŸ¥ (Advice)**    |    åˆ‡é¢åœ¨è¿æ¥ç‚¹æ‰§è¡Œçš„åŠ¨ä½œï¼ˆå®šä¹‰â€œ**ä½•æ—¶åš**â€ï¼‰ã€‚    |             åœ¨æ–¹æ³•æ‰§è¡Œå‰ï¼ˆ`@Before`ï¼‰è®°å½•æ—¥å¿—ã€‚              |
|   **åˆ‡ç‚¹ (Pointcut)**   |     é€šè¿‡è¡¨è¾¾å¼åŒ¹é…è¿æ¥ç‚¹ï¼ˆå®šä¹‰â€œ**åœ¨å“ªåš**â€ï¼‰ã€‚     | `@Pointcut("execution(* com.example.service.*.*(..))")` åŒ¹é… service åŒ…ä¸‹æ‰€æœ‰æ–¹æ³•ã€‚ |

> ğŸ“Œ **å…³ç³»æ€»ç»“**ï¼š
> åˆ‡é¢ = åˆ‡ç‚¹ï¼ˆWhereï¼‰ + é€šçŸ¥ï¼ˆWhen + Whatï¼‰

**äºŒã€Spring AOP çš„å®ç°åŸç†ï¼šåŠ¨æ€ä»£ç†**

Spring AOP åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œæ— éœ€ä¿®æ”¹æºç ã€‚å®ç°æ–¹å¼åŒ…æ‹¬ **JDK åŠ¨æ€ä»£ç†** å’Œ **CGLIB**ï¼š

**1.JDK åŠ¨æ€ä»£ç†**

- **æ¡ä»¶**ï¼šç›®æ ‡ç±» **å®ç°äº†æ¥å£**ï¼ˆå¦‚ `UserService` å®ç°äº† `IUserService`ï¼‰ã€‚

- æœºåˆ¶ï¼š

  - åˆ›å»º `InvocationHandler` å®ç°ç±»ï¼Œé‡å†™ `invoke()` æ–¹æ³•ï¼ˆåµŒå…¥é€šçŸ¥é€»è¾‘ï¼‰ã€‚
  - é€šè¿‡ `Proxy.newProxyInstance()` ç”Ÿæˆä»£ç†å¯¹è±¡ã€‚
  
- ç¤ºä¾‹ä»£ç ï¼š

  ```java
  public class JdkProxy implements InvocationHandler {
      private Object target;
      public Object bind(Object target) {
          this.target = target;
          return Proxy.newProxyInstance(
              target.getClass().getClassLoader(),
              target.getClass().getInterfaces(), 
              this
          );
      }
      @Override
      public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
          System.out.println("Before method: " + method.getName()); // å‰ç½®é€šçŸ¥
          Object result = method.invoke(target, args);               // æ‰§è¡Œç›®æ ‡æ–¹æ³•
          System.out.println("After method: " + method.getName());  // åç½®é€šçŸ¥
          return result;
      }
  }
  ```

**2. CGLIB ä»£ç†**

- **æ¡ä»¶**ï¼šç›®æ ‡ç±» **æœªå®ç°æ¥å£**ï¼ˆæ™®é€šç±»ï¼‰ã€‚

- æœºåˆ¶ï¼š

  - é€šè¿‡å­—èŠ‚ç å¢å¼ºæŠ€æœ¯ç”Ÿæˆç›®æ ‡ç±»çš„ **å­ç±»ä»£ç†**ã€‚
  - é‡å†™çˆ¶ç±»æ–¹æ³•å¹¶æ¤å…¥é€šçŸ¥é€»è¾‘ï¼ˆé€šè¿‡ `MethodInterceptor`ï¼‰ã€‚
  
- **é™åˆ¶**ï¼šæ— æ³•ä»£ç† `final` ç±»/æ–¹æ³•ï¼ˆæ— æ³•è¢«ç»§æ‰¿ï¼‰ã€‚

- ç¤ºä¾‹ä»£ç ï¼š

  ```java
  public class CglibProxy implements MethodInterceptor {
      public Object getProxy(Class<?> clazz) {
          Enhancer enhancer = new Enhancer();
          enhancer.setSuperclass(clazz);
          enhancer.setCallback(this);
          return enhancer.create();
      }
      @Override
      public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {
          System.out.println("Before: " + method.getName());  // å‰ç½®é€šçŸ¥
          Object result = proxy.invokeSuper(obj, args);      // æ‰§è¡Œçˆ¶ç±»æ–¹æ³•
          System.out.println("After: " + method.getName()); // åç½®é€šçŸ¥
          return result;
      }
  }
  ```

**Spring å¦‚ä½•é€‰æ‹©ä»£ç†æ–¹å¼ï¼Ÿ**

- è‹¥ç›®æ ‡ç±»å®ç°äº†æ¥å£ â†’ é»˜è®¤ä½¿ç”¨ **JDK åŠ¨æ€ä»£ç†**ã€‚

- è‹¥ç›®æ ‡ç±»æœªå®ç°æ¥å£ â†’ è‡ªåŠ¨åˆ‡æ¢ä¸º **CGLIB ä»£ç†**ã€‚

- å¼ºåˆ¶ä½¿ç”¨ CGLIBï¼š

  ```java
  @EnableAspectJAutoProxy(proxyTargetClass = true)  // å¼ºåˆ¶ä½¿ç”¨ CGLIB
  ```

**ä¸‰ã€AOP è§£å†³çš„å®é™…é—®é¢˜ï¼ˆé¡¹ç›®æ¡ˆä¾‹ï¼‰**

**1. ç»Ÿä¸€æ—¥å¿—è®°å½•**

- **é—®é¢˜**ï¼šä¸šåŠ¡æ–¹æ³•éœ€æ‰‹åŠ¨è°ƒç”¨æ—¥å¿—ä»£ç ï¼Œé‡å¤ä¸”ä¾µå…¥æ€§å¼ºã€‚

- AOP æ–¹æ¡ˆï¼š

  ```java
  @Aspect
  @Component
  public class LogAspect {
      // åˆ‡ç‚¹ï¼šservice åŒ…ä¸‹æ‰€æœ‰æ–¹æ³•
      @Pointcut("execution(* com.example.service.*.*(..))")
      public void servicePointcut() {}
      
      // å‰ç½®é€šçŸ¥ï¼šè®°å½•æ–¹æ³•åå’Œå‚æ•°
      @Before("servicePointcut()")
      public void logBefore(JoinPoint joinPoint) {
          String methodName = joinPoint.getSignature().getName();
          Object[] args = joinPoint.getArgs();
          Logger.info("Method {} called with args: {}", methodName, Arrays.toString(args));
      }
  }
  ```
  
- æ•ˆæœï¼š

  - æ—¥å¿—é€»è¾‘ä¸ä¸šåŠ¡ä»£ç è§£è€¦ï¼Œæ–°å¢æ–¹æ³•æ— éœ€ä¿®æ”¹æ—¥å¿—ä»£ç ã€‚
- æ—¥å¿—æ ¼å¼ç»Ÿä¸€ï¼Œä¾¿äºç›‘æ§åˆ†æã€‚

**2. å£°æ˜å¼äº‹åŠ¡ç®¡ç†**

- **é—®é¢˜**ï¼šäº‹åŠ¡ä»£ç ï¼ˆ`beginTransaction()` / `commit()` / `rollback()`ï¼‰åˆ†æ•£åœ¨å„ä¸šåŠ¡æ–¹æ³•ä¸­ã€‚

- AOP æ–¹æ¡ˆï¼š

  ```java
  @Aspect
  @Component
  public class TransactionAspect {
      @Autowired
      private PlatformTransactionManager transactionManager;
      
      @Around("@annotation(org.springframework.transaction.annotation.Transactional)")
      public Object manageTransaction(ProceedingJoinPoint joinPoint) throws Throwable {
          TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());
          try {
              Object result = joinPoint.proceed(); // æ‰§è¡Œç›®æ ‡æ–¹æ³•
              transactionManager.commit(status);    // æäº¤äº‹åŠ¡
              return result;
          } catch (Exception e) {
              transactionManager.rollback(status); // å›æ»šäº‹åŠ¡
              throw e;
          }
      }
  }
  ```
  
- æ•ˆæœï¼š

  - é€šè¿‡ `@Transactional` æ³¨è§£æ§åˆ¶äº‹åŠ¡èŒƒå›´ï¼Œæ— éœ€æ‰‹åŠ¨ç¼–å†™æ¨¡æ¿ä»£ç ã€‚
- äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼ˆå¦‚ `REQUIRED`/`REQUIRES_NEW`ï¼‰å¯é…ç½®åŒ–ã€‚

**3. æƒé™æ ¡éªŒ**

- **é—®é¢˜**ï¼šæƒé™åˆ¤æ–­é€»è¾‘åˆ†æ•£åœ¨ Controller æ–¹æ³•ä¸­ï¼Œéš¾ä»¥å¤ç”¨å’Œç»´æŠ¤ã€‚

- AOP æ–¹æ¡ˆï¼š

  ```java
  @Aspect
  @Component
  public class AuthAspect {
      // åˆ‡ç‚¹ï¼šæ ‡æ³¨ @RequirePermission æ³¨è§£çš„æ–¹æ³•
      @Before("@annotation(requirePermission)")
      public void checkPermission(JoinPoint joinPoint, RequirePermission requirePermission) {
          String role = requirePermission.value(); // è·å–æ³¨è§£ä¸­å®šä¹‰çš„æƒé™
          User user = CurrentUser.get();
          if (!user.hasRole(role)) {
              throw new AccessDeniedException("Permission denied!");
          }
      }
  }
  
  // è‡ªå®šä¹‰æƒé™æ³¨è§£
  @Retention(RetentionPolicy.RUNTIME)
  @Target(ElementType.METHOD)
  public @interface RequirePermission {
      String value(); // æƒé™æ ‡è¯†ï¼ˆå¦‚ "admin"ï¼‰
  }
  
  // åœ¨ Controller ä¸­ä½¿ç”¨
  @RestController
  public class UserController {
      @RequirePermission("admin")
      @DeleteMapping("/user/{id}")
      public void deleteUser(@PathVariable Long id) {
          // åˆ é™¤ç”¨æˆ·é€»è¾‘
      }
  }
  ```
  
- æ•ˆæœï¼š

  - æƒé™æ ¡éªŒé€»è¾‘é›†ä¸­ç®¡ç†ï¼Œä¸šåŠ¡æ–¹æ³•ä»…éœ€å£°æ˜æ‰€éœ€æƒé™ã€‚
- æ–°å¢æ¥å£æ—¶åªéœ€æ·»åŠ æ³¨è§£ï¼Œé¿å…é‡å¤ç¼–å†™æ ¡éªŒä»£ç ã€‚

**æ€»ç»“**

- **AOP ä»·å€¼**ï¼šé€šè¿‡è§£è€¦æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œæå‡ä»£ç å¯ç»´æŠ¤æ€§å’Œå¤ç”¨æ€§ã€‚

- Spring AOP å®ç°ï¼š

  - **JDK åŠ¨æ€ä»£ç†** â†’ åŸºäºæ¥å£ï¼Œé€šè¿‡ `InvocationHandler` å®ç°ã€‚
  - **CGLIB** â†’ åŸºäºç»§æ‰¿ï¼Œé€šè¿‡å­—èŠ‚ç å¢å¼ºç”Ÿæˆå­ç±»ä»£ç†ã€‚
  
- **å…¸å‹åº”ç”¨åœºæ™¯**ï¼šæ—¥å¿—ã€äº‹åŠ¡ã€æƒé™ã€æ€§èƒ½ç›‘æ§ã€ç¼“å­˜ç­‰ã€‚

> ğŸ”§ **ä¼˜åŒ–å»ºè®®**ï¼š
> åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç»“åˆ `Spring Cloud Sleuth` å’Œ AOP å¯å®ç°å…¨é“¾è·¯æ—¥å¿—è·Ÿè¸ªï¼ˆTraceID é€ä¼ ï¼‰ï¼Œè¿›ä¸€æ­¥å¼ºåŒ–å¯è§‚æµ‹æ€§ã€‚