---
title: Spring Data Elasticsearch æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ
published: 2025-05-25
description: Spring Data Elasticsearch å’ŒåŸç”Ÿçš„ Elasticsearch Java API æˆ– RestHighLevelClient ç›¸æ¯”ï¼Œæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿåœ¨äºŒæ¬¡å¼€å‘ SPMS æ—¶ï¼Œæ•°æ®åŒæ­¥é€»è¾‘é‡æ„çš„å…·ä½“æŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼Ÿ
tags: [Markdown, Blogging]
category: Java mianshi
licenseName: "Unlicensed"
author: Ankou
sourceLink: ''
draft: false
---
**ä½ å®ä¹ ä¸­ä½¿ç”¨çš„ Spring Data Elasticsearch å’ŒåŸç”Ÿçš„ Elasticsearch Java API æˆ– RestHighLevelClient ç›¸æ¯”ï¼Œæœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿåœ¨äºŒæ¬¡å¼€å‘ SPMS æ—¶ï¼Œæ•°æ®åŒæ­¥é€»è¾‘é‡æ„çš„å…·ä½“æŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼Ÿ**

**ä¸€ã€Spring Data Elasticsearch (SDE) vs åŸç”Ÿ API å¯¹æ¯”åˆ†æ**

**1. Spring Data Elasticsearch (SDE) çš„ä¼˜ç¼ºç‚¹**

|    **ç»´åº¦**    |                           **ä¼˜ç‚¹**                           |                           **ç¼ºç‚¹**                           |
| :------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
|  **å¼€å‘æ•ˆç‡**  | **æç®€çš„ Repository æ¥å£**ï¼š `interface UserRepo extends ElasticsearchRepository<User, String>` è‡ªåŠ¨å®ç° CRUD æ–¹æ³•ã€‚  **æ–¹æ³•åè‡ªåŠ¨æ¨å¯¼ DSL**ï¼š `findByNameAndAge(String name, int age)` â†’ è‡ªåŠ¨ç”Ÿæˆ Query DSLã€‚ | **å¤æ‚æŸ¥è¯¢å—é™**ï¼š åµŒå¥—èšåˆã€è„šæœ¬æŸ¥è¯¢ç­‰éœ€é€€å›åˆ° `NativeSearchQuery`ï¼Œä»£ç å†—é•¿ã€‚ |
| **ä»£ç ç®€æ´æ€§** | **æ³¨è§£æ˜ å°„å®ä½“**ï¼š `@Document`ã€`@Field` è‡ªåŠ¨æ˜ å°„å­—æ®µç±»å‹ã€‚ **é¿å…æ‰‹å†™ JSON**ï¼š ç›´æ¥æ“ä½œ Java å¯¹è±¡è€Œé JSON å­—ç¬¦ä¸²ã€‚ | **çµæ´»æ€§ä¸è¶³**ï¼š ç‰¹æ®Šå­—æ®µé…ç½®ï¼ˆå¦‚åˆ†è¯å™¨ï¼‰éœ€æ··åˆ XML æˆ– JSON é…ç½®ã€‚ |
|  **äº‹åŠ¡æ”¯æŒ**  | **ä¸ Spring äº‹åŠ¡é›†æˆ**ï¼š `@Transactional` æ”¯æŒ ACID äº‹åŠ¡ï¼ˆéœ€ ES 7+ çš„ä¹è§‚é”ï¼‰ã€‚ |       **éå¼ºä¸€è‡´æ€§åœºæ™¯**ï¼š åˆ†å¸ƒå¼ç¯å¢ƒä¸‹äº‹åŠ¡æ€§èƒ½è¾ƒä½ã€‚        |
|  **ç»´æŠ¤æˆæœ¬**  | **Spring ç”Ÿæ€æ— ç¼æ•´åˆ**ï¼š ç»Ÿä¸€ä¾èµ–ç®¡ç†ã€é…ç½®ï¼ˆ`application.yml`ï¼‰ã€‚ | **ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜**ï¼š SDE ç‰ˆæœ¬éœ€ä¸¥æ ¼åŒ¹é… ES ç‰ˆæœ¬ï¼ˆå¦‚ SDE 4.x ä»…æ”¯æŒ ES 7.xï¼‰ã€‚ |

**2. åŸç”Ÿ Elasticsearch API çš„ä¼˜ç¼ºç‚¹**

|   **ç»´åº¦**   |                           **ä¼˜ç‚¹**                           |                           **ç¼ºç‚¹**                           |
| :----------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
|  **çµæ´»æ€§**  | **å®Œå…¨æ§åˆ¶ DSL**ï¼š è‡ªç”±ç¼–å†™ä»»ä½•å¤æ‚åº¦çš„ Query DSLï¼ˆå¦‚ç®¡é“èšåˆã€è„šæœ¬æŸ¥è¯¢ï¼‰ã€‚  **ç»†ç²’åº¦æ€§èƒ½ä¼˜åŒ–**ï¼š æ‰‹åŠ¨æ§åˆ¶åˆ†ç‰‡è·¯ç”±ã€æœç´¢ç±»å‹ã€‚ |  **ä»£ç å†—ä½™**ï¼š éœ€æ‰‹åŠ¨è§£æ `SearchResponse` çš„ JSON ç»“æ„ã€‚   |
|  **å…¼å®¹æ€§**  |    **é€‚é…ä»»æ„ ES ç‰ˆæœ¬**ï¼š é€šè¿‡è°ƒæ•´ä¾èµ–ç‰ˆæœ¬å…¼å®¹è€ç‰ˆæœ¬ ESã€‚    |   **å‡çº§æˆæœ¬é«˜**ï¼š ES å¤§ç‰ˆæœ¬å‡çº§éœ€é‡å†™å¤§é‡åŸç”Ÿ API è°ƒç”¨ã€‚    |
| **æ€§èƒ½æ§åˆ¶** | **é¿å¼€æŠ½è±¡å±‚å¼€é”€**ï¼š ç›´æ¥è°ƒç”¨ `RestHighLevelClient` å‡å°‘åºåˆ—åŒ–æŸè€—ã€‚ | **å­¦ä¹ æ›²çº¿é™¡å³­**ï¼š éœ€æ·±å…¥æŒæ¡ ES çš„ REST API å’Œ Java Client ç»†èŠ‚ã€‚ |

> ğŸ’¡ **æ€»ç»“**ï¼š
>
> - **é€‰ SDE å½“**ï¼šå¿«é€Ÿå¼€å‘ CRUDã€ç®€å•æœç´¢ã€éœ€è¦ Spring ç”Ÿæ€é›†æˆã€‚
> - **é€‰åŸç”Ÿ API å½“**ï¼šéœ€è¦å¤æ‚èšåˆã€è„šæœ¬æ§åˆ¶ã€æ€§èƒ½è°ƒä¼˜æˆ–å…¼å®¹å¤šç‰ˆæœ¬ ESã€‚

**äºŒã€SPMS æ•°æ®åŒæ­¥é‡æ„çš„æ ¸å¿ƒæŒ‘æˆ˜**

åœ¨å°†æ•°æ®åŒæ­¥æ–¹æ¡ˆä» **Logstash + JDBC** é‡æ„ä¸º **Spring Data Elasticsearch Stream API** æ—¶ï¼Œé¢ä¸´ä»¥ä¸‹å…³é”®æŒ‘æˆ˜ï¼š

**1. å®æ—¶æ€§ vs èµ„æºæ¶ˆè€—**

|          **åŸæ–¹æ¡ˆ (Logstash)**           |          **æ–°æ–¹æ¡ˆ (SDE Data Stream)**           |                           **æŒ‘æˆ˜**                           |
| :--------------------------------------: | :---------------------------------------------: | :----------------------------------------------------------: |
| **å®šæ—¶è½®è¯¢**ï¼š æ¯åˆ†é’Ÿæ‹‰å–å…¨é‡/å¢é‡æ•°æ®ã€‚ | **äº‹ä»¶é©±åŠ¨**ï¼š ç›‘å¬ MySQL Binlog æˆ–åº”ç”¨å±‚äº‹ä»¶ã€‚ | **å®æ—¶æ€§è¦æ±‚**ï¼š éœ€ä¿è¯è®¾å¤‡çŠ¶æ€å˜æ›´ 5 ç§’å†…åŒæ­¥åˆ° ESã€‚  **èµ„æºå¼€é”€**ï¼š æŒç»­ç›‘å¬ Binlog å ç”¨æ•°æ®åº“è¿æ¥èµ„æºã€‚ |

**è§£å†³æ–¹æ¡ˆ**ï¼š

- ä½¿ç”¨ **Debezium** æ•è· Binlog äº‹ä»¶ â†’ Kafka â†’ SDE æ¶ˆè´¹ã€‚
- é™çº§æ–¹æ¡ˆï¼šå¢é‡ ID + æ—¶é—´æˆ³åŒç¼“å†²åŒæ­¥ï¼ˆç¡®ä¿æ–­ç‚¹ç»­ä¼ ï¼‰ã€‚

**2. æ•°æ®ä¸€è‡´æ€§ä¸é”™è¯¯å¤„ç†**

|      **é—®é¢˜åœºæ™¯**      |            **é£é™©**            |                       **è§£å†³æ–¹æ¡ˆ**                        |
| :--------------------: | :----------------------------: | :-------------------------------------------------------: |
| **åŒæ­¥è¿‡ç¨‹ä¸­åº”ç”¨å®•æœº** |          éƒ¨åˆ†æ•°æ®ä¸¢å¤±          |  **æŒä¹…åŒ–æ¶ˆè´¹ä½ç‚¹**ï¼š å°† Kafka offset å­˜å‚¨åˆ° Redis/DBã€‚   |
|    **ES å†™å…¥å¤±è´¥**     |         ä¸æºæ•°æ®ä¸ä¸€è‡´         | **é‡è¯•é˜Ÿåˆ— + æ­»ä¿¡é˜Ÿåˆ—**ï¼š å¤±è´¥æ¶ˆæ¯è½¬å­˜ MongoDB äººå·¥ä¿®å¤ã€‚ |
|    **æ•°æ®ç»“æ„å˜æ›´**    | ç´¢å¼•æ˜ å°„å†²çªï¼ˆå¦‚å­—æ®µç±»å‹å˜æ›´ï¼‰ |    **åŒå†™æ¨¡å¼**ï¼š åŒæ—¶å†™æ–°æ—§ç´¢å¼•ï¼Œåˆ‡æ¢åˆ«åå®Œæˆçƒ­è¿ç§»ã€‚    |

**3. åŒæ­¥æ€§èƒ½ä¼˜åŒ–**

|        **ç“¶é¢ˆ**        |                         **ä¼˜åŒ–æ‰‹æ®µ**                         |
| :--------------------: | :----------------------------------------------------------: |
| **MySQL æ‰¹é‡æŸ¥è¯¢å‹åŠ›** | **å¢é‡æ¸¸æ ‡åˆ†é¡µ**ï¼š `WHERE id > last_id ORDER BY id LIMIT 1000`ã€‚  **å¤šçº¿ç¨‹åˆ†ç‰‡æ‹‰å–**ï¼šæŒ‰è®¾å¤‡ ID å“ˆå¸Œåˆ†ç‰‡å¹¶è¡ŒåŒæ­¥ã€‚ |
| **ES å†™å…¥ååé‡ä¸è¶³**  | **æ‰¹é‡æäº¤ (Bulk API)**ï¼š åˆå¹¶ 500 æ¡æ¶ˆæ¯ä¸€æ¬¡æäº¤ã€‚  **è°ƒæ•´åˆ·æ–°é—´éš”**ï¼š`index.refresh_interval=30s`ã€‚ |
|      **ç½‘ç»œå»¶è¿Ÿ**      | **ES å®¢æˆ·ç«¯é•¿è¿æ¥å¤ç”¨**ï¼š é…ç½®è¿æ¥æ±  `max_total=200`ï¼Œ`keep_alive=5min`ã€‚ |

**4. äº‹åŠ¡æ€§ä¿éšœ**

```java
// SDE æ— æ³•å®ç°è·¨ MySQL å’Œ ES çš„åˆ†å¸ƒå¼äº‹åŠ¡ â†’ æœ€ç»ˆä¸€è‡´æ€§è¡¥å¿
@Transactional
public void updateDeviceStatus(Device device) {
    // 1. æ›´æ–° MySQL
    deviceRepository.save(device); 
    
    // 2. å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼ˆè§£è€¦ï¼‰
    applicationEventPublisher.publishEvent(
        new DeviceStatusEvent(device.getId(), device.getStatus())
    );
}

// ç›‘å¬äº‹ä»¶å¼‚æ­¥åŒæ­¥åˆ° ES
@EventListener
public void syncToEs(DeviceStatusEvent event) {
    IndexQuery query = new IndexQueryBuilder()
        .withId(event.getDeviceId())
        .withObject(/* æ„å»º ES æ–‡æ¡£ */)
        .build();
        
    // é‡è¯•ç­–ç•¥ï¼ˆExponential Backoffï¼‰
    elasticsearchOperations.index(query, IndexCoordinates.of("device_index"));
}
```

**ä¸‰ã€é‡æ„åçš„æ”¶ç›Šä¸å»ºè®®**

|    **æŒ‡æ ‡**    |        **é‡æ„å‰ (Logstash)**        |     **é‡æ„å (SDE Stream)**     |
| :------------: | :---------------------------------: | :-----------------------------: |
|  **åŒæ­¥å»¶è¿Ÿ**  |       åˆ†é’Ÿçº§ï¼ˆä¾èµ–è½®è¯¢é—´éš”ï¼‰        |        ç§’çº§ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰         |
|  **èµ„æºå ç”¨**  | é«˜ï¼ˆå…¨è¡¨æ‰«æ + ä¸­é—´ Logstash èŠ‚ç‚¹ï¼‰ |    ä½ï¼ˆç›´è¿ ES + æ‰¹é‡æäº¤ï¼‰     |
| **ç»´æŠ¤å¤æ‚åº¦** |   é«˜ï¼ˆéœ€ç»´æŠ¤ Logstash ç®¡é“é…ç½®ï¼‰    | ä½ï¼ˆçº¯ Java ä»£ç ï¼ŒSpring æ‰˜ç®¡ï¼‰ |
|   **æ‰©å±•æ€§**   |       å¼±ï¼ˆéš¾ä»¥åº”å¯¹åˆ†åº“åˆ†è¡¨ï¼‰        |    å¼ºï¼ˆKafka åˆ†åŒºå¹¶è¡Œæ¶ˆè´¹ï¼‰     |

**ç»™å¼€å‘è€…çš„å»ºè®®**ï¼š

1. **å®æ—¶æ€§è¦æ±‚é«˜** â†’ é€‰æ‹© **Binlog + æ¶ˆæ¯é˜Ÿåˆ—** é©±åŠ¨åŒæ­¥ã€‚
2. **æ•°æ®é‡å°** â†’ å¯ç”¨ **Spring Batch** åˆ†é¡µæ‰¹å¤„ç† + å®šæ—¶ä»»åŠ¡ã€‚
3. **å¼ºä¸€è‡´æ€§éœ€æ±‚** â†’ ç»“åˆ **Transactional Outbox Pattern**ï¼ˆäº‹åŠ¡æ€§å‘ä»¶ç®±ï¼‰ã€‚
4. **å†å²æ•°æ®è¿ç§»** â†’ ä½¿ç”¨ **Logstash åˆå§‹åŒ–**ï¼Œ**SDE åŒæ­¥å¢é‡**ï¼ˆæ–°æ—§æ–¹æ¡ˆå¹¶å­˜è¿‡æ¸¡ï¼‰ã€‚